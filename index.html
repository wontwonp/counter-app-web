<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>정류장 카운터</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: all 0.3s ease;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        .container {
            text-align: center;
            padding: 20px;
            max-width: 600px;
            width: 100%;
        }

        h1 {
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        h2 {
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        h3 {
            margin-bottom: 15px;
            font-size: 1.4rem;
        }

        /* 정류장 개수 입력 페이지 */
        .station-count-input {
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .number-input {
            font-size: 1.5rem;
            padding: 15px 20px;
            margin: 20px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            text-align: center;
            width: 200px;
        }

        .submit-btn {
            font-size: 1.2rem;
            padding: 15px 30px;
            margin: 20px;
            border: none;
            border-radius: 10px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-btn:hover:not(:disabled) {
            background: #45a049;
            transform: translateY(-2px);
        }

        .submit-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        /* 정류장 이름 입력 페이지 */
        .station-names-input {
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
        }

        .station-inputs {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        .station-input-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .station-input-group label {
            min-width: 100px;
            text-align: left;
            font-size: 1.1rem;
        }

        .station-name-input {
            flex: 1;
            font-size: 1.1rem;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .button-group {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .start-btn, .reset-btn {
            font-size: 1.2rem;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .start-btn {
            background: #4CAF50;
            color: white;
        }

        .start-btn:hover:not(:disabled) {
            background: #45a049;
            transform: translateY(-2px);
        }

        .start-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .reset-btn {
            background: #f44336;
            color: white;
        }

        .reset-btn:hover {
            background: #da190b;
            transform: translateY(-2px);
        }

        /* 키패드 페이지 */
        .current-station {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .current-station h2 {
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .current-station p {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .clock-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-family: 'Courier New', monospace;
        }

        .clock-time {
            font-size: 2rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 5px;
        }

        .clock-date {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .input-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .number-display {
            font-size: 2rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .keypad {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .keypad-row {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .keypad-btn {
            width: 90px;
            height: 90px;
            font-size: 1.8rem;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            transition: all 0.1s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0.3);
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .keypad-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .keypad-btn:active {
            background: rgba(255, 255, 255, 0.4);
            transform: translateY(-1px) scale(0.95);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .enter-btn {
            width: 285px;
            height: 90px;
            font-size: 1.8rem;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            transition: all 0.1s ease;
            -webkit-tap-highlight-color: rgba(76, 175, 80, 0.3);
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .enter-btn:hover {
            background: #45a049;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .enter-btn:active {
            background: #3d8b40;
            transform: translateY(-1px) scale(0.95);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* 정류장 요약 */
        .station-summary {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 400px;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
        }

        .summary-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .summary-item {
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .summary-item.current {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4CAF50;
            font-weight: bold;
        }

        .reset-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .reset-counts-btn, .reset-app-btn {
            font-size: 1.1rem;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .delete-previous-btn {
            font-size: 1.1rem;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #9C27B0;
        }

        .delete-previous-btn:hover {
            background: #7B1FA2;
            transform: translateY(-2px);
        }

        .reset-counts-btn {
            background: #ff9800;
        }

        .reset-counts-btn:hover {
            background: #f57c00;
            transform: translateY(-2px);
        }

        .reset-app-btn {
            background: #f44336;
        }

        .reset-app-btn:hover {
            background: #da190b;
            transform: translateY(-2px);
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .station-count-input, .station-names-input {
                padding: 20px;
            }
            
            .station-input-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .station-input-group label {
                text-align: center;
                min-width: auto;
            }
            
            .keypad-btn {
                width: 70px;
                height: 70px;
                font-size: 1.4rem;
            }
            
            .enter-btn {
                width: 225px;
                height: 70px;
                font-size: 1.4rem;
            }
            
            .number-display {
                font-size: 1.8rem;
            }
        }

        .hidden {
            display: none;
        }

        /* 저장된 노선 관련 스타일 */
        .saved-route-item {
            position: relative;
            margin-bottom: 10px;
        }

        .saved-route-btn {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .saved-route-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .route-name {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .route-info {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .delete-route-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: none;
            background: #f44336;
            color: white;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .delete-route-btn:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }

        .save-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .save-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .save-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        /* 다크모드 토글 버튼 */
        .theme-toggle {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            font-size: 1.3rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        /* 다크모드에서의 카드 스타일 조정 */
        body.dark-mode .station-count-input,
        body.dark-mode .station-names-input,
        body.dark-mode .current-station,
        body.dark-mode .clock-display,
        body.dark-mode .input-display,
        body.dark-mode .station-summary {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.dark-mode .keypad-btn {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        body.dark-mode .keypad-btn:hover {
            background: rgba(0, 0, 0, 0.5);
        }

        /* 공유 버튼 스타일 */
        .share-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .share-btn, .download-btn {
            font-size: 1.1rem;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .share-btn {
            background: #FEE500;
            color: #3C1E1E;
        }

        .share-btn:hover {
            background: #FFD700;
            transform: translateY(-2px);
        }

        /* 이미지 미리보기 모달 */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .image-modal.show {
            display: flex;
        }

        .image-modal-content {
            background: white;
            padding: 20px;
            border-radius: 15px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
        }

        .image-modal img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 2rem;
            color: white;
            cursor: pointer;
        }

        /* 시간대 선택 버튼 스타일 */
        .time-period-btn {
            font-size: 1.1rem;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .time-period-btn.active {
            background: #4CAF50;
            border: 2px solid #4CAF50;
            transform: translateY(-2px);
        }

        .time-period-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .time-period-btn.active:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()" id="theme-toggle">🌙</button>
    <div class="container">
        <h1>정류장 카운터</h1>
        
        <!-- 정류장 개수 입력 페이지 -->
        <div id="station-count-page">
            <!-- 저장된 노선 목록 -->
            <div class="station-count-input" style="margin-bottom: 20px;">
                <h2>저장된 노선</h2>
                <div id="saved-routes-container">
                    <p style="color: #999; text-align: center; margin: 10px 0;">저장된 노선이 없습니다.</p>
                </div>
            </div>
            
            <div class="station-count-input">
                <h2>노선 정보를 입력하세요</h2>
                <div style="margin-bottom: 20px;">
                    <label for="route-name" style="display: block; margin-bottom: 10px; font-size: 1.1rem;">노선 이름:</label>
                    <input type="text" id="route-name" placeholder="예: 명지2 노선" class="number-input" style="width: 300px;" lang="ko" ime-mode="active">
                </div>
                <h3>정류장 개수를 입력하세요</h3>
                <input type="number" id="station-count" min="1" max="20" placeholder="정류장 개수" class="number-input" oninput="updateStationCount()">
                <button id="count-submit" class="submit-btn" onclick="submitStationCount()" disabled>확인</button>
            </div>
        </div>

        <!-- 정류장 이름 입력 페이지 -->
        <div id="station-names-page" class="hidden">
            <div class="station-names-input">
                <h2>정류장 이름을 입력하세요</h2>
                <div id="station-inputs" class="station-inputs"></div>
                <div class="button-group">
                    <button id="start-counting" class="start-btn" onclick="startCounting()" disabled>카운팅 시작</button>
                    <button id="save-route" class="save-btn" onclick="saveRoute()" disabled>노선 저장</button>
                    <button id="reset-setup" class="reset-btn" onclick="resetSetup()">다시 설정</button>
                </div>
            </div>
        </div>

        <!-- 키패드 페이지 -->
        <div id="keypad-page" class="hidden">
            <div class="current-station">
                <h2 id="current-station-name">현재 정류장: </h2>
                <p id="current-station-count">총 탑승자수: 0</p>
            </div>

            <!-- 시간대 토글 버튼 -->
            <div style="margin-bottom: 15px;">
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button id="morning-btn-keypad" class="time-period-btn active" onclick="selectTimePeriod('morning')">오전 운행</button>
                    <button id="afternoon-btn-keypad" class="time-period-btn" onclick="selectTimePeriod('afternoon')">오후 운행</button>
                </div>
            </div>

            <div class="clock-display">
                <div id="clock-time" class="clock-time">00:00:00</div>
                <div id="clock-date" class="clock-date">2024년 1월 1일 월요일</div>
            </div>

            <div class="input-display">
                <div id="number-display" class="number-display">0</div>
            </div>

            <div class="keypad">
                <div class="keypad-row">
                    <button class="keypad-btn" onclick="inputDigit('1')">1</button>
                    <button class="keypad-btn" onclick="inputDigit('2')">2</button>
                    <button class="keypad-btn" onclick="inputDigit('3')">3</button>
                </div>
                <div class="keypad-row">
                    <button class="keypad-btn" onclick="inputDigit('4')">4</button>
                    <button class="keypad-btn" onclick="inputDigit('5')">5</button>
                    <button class="keypad-btn" onclick="inputDigit('6')">6</button>
                </div>
                <div class="keypad-row">
                    <button class="keypad-btn" onclick="inputDigit('7')">7</button>
                    <button class="keypad-btn" onclick="inputDigit('8')">8</button>
                    <button class="keypad-btn" onclick="inputDigit('9')">9</button>
                </div>
                <div class="keypad-row">
                    <button class="keypad-btn" onclick="clearInput()">C</button>
                    <button class="keypad-btn" onclick="inputDigit('0')">0</button>
                    <button class="keypad-btn" onclick="backspace()">⌫</button>
                </div>
                <div class="keypad-row">
                    <button class="enter-btn" onclick="enterNumber()">ENTER</button>
                </div>
            </div>

            <div class="station-summary">
                <h3>정류장별 카운트</h3>
                <div id="summary-list" class="summary-list"></div>
            </div>

            <div class="reset-buttons">
                <button onclick="deletePreviousStation()" class="delete-previous-btn">직전 정류장 삭제</button>
                <button onclick="resetCounts()" class="reset-counts-btn">정류장 명수 초기화</button>
                <button onclick="resetApp()" class="reset-app-btn">처음으로</button>
            </div>

            <div class="share-buttons">
                <button onclick="generateAndShareImage()" class="share-btn" id="kakao-share-btn">
                    📱 카카오톡 공유
                </button>
            </div>
        </div>
    </div>

    <!-- 이미지 미리보기 모달 -->
    <div id="image-modal" class="image-modal">
        <button class="modal-close" onclick="closeImageModal()">&times;</button>
        <div class="image-modal-content">
            <img id="generated-image" src="" alt="생성된 이미지">
        </div>
    </div>

    <script>
        // 전역 변수
        let stations = [];
        let stationNames = [];
        let currentStationIndex = 0;
        let currentInput = '';
        let stationCount = 0;
        let isDarkMode = false;
        let routeName = '';
        let stationDepartureTimes = [];
        let selectedTimePeriod = 'morning'; // 'morning' 또는 'afternoon'

        // 다크모드 토글 함수
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            const body = document.body;
            const themeToggle = document.getElementById('theme-toggle');
            
            if (isDarkMode) {
                body.classList.add('dark-mode');
                themeToggle.textContent = '☀️';
                localStorage.setItem('darkMode', 'true');
            } else {
                body.classList.remove('dark-mode');
                themeToggle.textContent = '🌙';
                localStorage.setItem('darkMode', 'false');
            }
        }

        // 페이지 로드 시 저장된 테마 설정 불러오기
        function loadTheme() {
            const savedTheme = localStorage.getItem('darkMode');
            if (savedTheme === 'true') {
                isDarkMode = true;
                document.body.classList.add('dark-mode');
                document.getElementById('theme-toggle').textContent = '☀️';
            }
        }

        // 정류장 개수 업데이트 함수
        function updateStationCount() {
            stationCount = parseInt(document.getElementById('station-count').value) || 0;
            routeName = document.getElementById('route-name').value.trim();
            document.getElementById('count-submit').disabled = stationCount <= 0 || routeName === '';
        }

        // 날짜 변경 확인 및 완전 초기화
        function checkDateChangeAndReset() {
            const now = new Date();
            const currentDate = now.toDateString(); // "Mon Jan 01 2024" 형식
            const savedDate = localStorage.getItem('lastResetDate');
            
            if (savedDate && savedDate !== currentDate) {
                console.log(`날짜 변경 감지: ${savedDate} → ${currentDate}`);
                console.log('24시가 지나 완전 초기화를 실행합니다.');
                
                // 완전 초기화 실행
                completeReset();
                
                // 새로운 날짜 저장
                localStorage.setItem('lastResetDate', currentDate);
            } else if (!savedDate) {
                // 처음 실행하는 경우 현재 날짜 저장
                localStorage.setItem('lastResetDate', currentDate);
            }
        }

        // 완전 초기화 함수
        function completeReset() {
            if (stations && stations.length > 0) {
                stations.forEach(station => {
                    station.count = 0;
                    station.morningCount = 0;
                    station.afternoonCount = 0;
                });
                currentStationIndex = 0;
                currentInput = '';
                enableKeypad();
                updateKeypadPage();
                localStorage.setItem('savedStations', JSON.stringify(stations));
                console.log('24시 경과로 인한 완전 초기화가 완료되었습니다.');
            }
        }

        // 현재 시간에 따라 자동으로 시간대 선택
        function autoSelectTimePeriod() {
            // 먼저 날짜 변경 확인
            checkDateChangeAndReset();
            
            const now = new Date();
            const currentHour = now.getHours();
            
            // 오전: 6시~12시, 오후: 13시~22시
            if (currentHour >= 6 && currentHour < 12) {
                selectedTimePeriod = 'morning';
            } else if (currentHour >= 13 && currentHour < 22) {
                selectedTimePeriod = 'afternoon';
            } else {
                // 새벽이나 밤 시간대는 오전으로 기본 설정
                selectedTimePeriod = 'morning';
            }
            
            console.log(`현재 시간: ${currentHour}시, 자동 선택된 시간대: ${selectedTimePeriod}`);
            
            // 버튼 업데이트
            updateTimePeriodButtons();
            
            // localStorage에 저장
            localStorage.setItem('selectedTimePeriod', selectedTimePeriod);
        }

        // 시간대 선택 함수 (수동 선택용)
        function selectTimePeriod(period) {
            // 날짜 변경 확인
            checkDateChangeAndReset();
            
            const previousPeriod = selectedTimePeriod;
            selectedTimePeriod = period;
            updateTimePeriodButtons();
            
            // 키패드 페이지 업데이트 (시간 표시 변경)
            if (!document.getElementById('keypad-page').classList.contains('hidden')) {
                // 오전에서 오후로 전환하거나 오후에서 오전으로 전환할 때 키패드 재활성화 및 첫 번째 정류장으로 이동
                if (previousPeriod !== period) {
                    enableKeypad();
                    currentStationIndex = 0; // 첫 번째 정류장부터 시작
                    currentInput = ''; // 입력 초기화
                    console.log(`${previousPeriod}에서 ${period}로 전환 - 키패드 재활성화, 첫 번째 정류장으로 이동`);
                }
                
                updateKeypadPage();
            }
            
            // localStorage에 저장
            localStorage.setItem('selectedTimePeriod', period);
        }

        // 시간대 버튼 업데이트 함수
        function updateTimePeriodButtons() {
            // 키패드 화면 버튼 업데이트
            const morningBtnKeypad = document.getElementById('morning-btn-keypad');
            const afternoonBtnKeypad = document.getElementById('afternoon-btn-keypad');
            if (morningBtnKeypad && afternoonBtnKeypad) {
                morningBtnKeypad.classList.remove('active');
                afternoonBtnKeypad.classList.remove('active');
                
                if (selectedTimePeriod === 'morning') {
                    morningBtnKeypad.classList.add('active');
                } else {
                    afternoonBtnKeypad.classList.add('active');
                }
            }
        }

        // 정류장 개수 제출 함수
        function submitStationCount() {
            stationCount = parseInt(document.getElementById('station-count').value) || 0;
            routeName = document.getElementById('route-name').value.trim();
            
            if (routeName === '') {
                return;
            }
            
            if (stationCount > 0) {
                // 저장된 정류장 이름 불러오기
                const savedStations = JSON.parse(localStorage.getItem('savedStations') || '[]');
                const savedDepartureTimes = JSON.parse(localStorage.getItem('savedDepartureTimes') || '[]');
                
                stations = Array.from({ length: stationCount }, (_, index) => ({
                    id: index,
                    name: savedStations[index] || '',
                    count: 0,
                    morningCount: 0,
                    afternoonCount: 0,
                    departureTime: savedDepartureTimes[index] || { 
                        morningHour: 8, 
                        afternoonHour: 17, 
                        minute: Math.min(index * 5, 59) 
                    }
                }));
                stationNames = new Array(stationCount).fill('');
                stationDepartureTimes = new Array(stationCount).fill({ hour: 8, minute: 0, ampm: 'AM' });
                createStationInputs();
                document.getElementById('station-count-page').classList.add('hidden');
                document.getElementById('station-names-page').classList.remove('hidden');
            }
        }

        // 정류장 이름 입력 필드 생성
        function createStationInputs() {
            const stationInputs = document.getElementById('station-inputs');
            stationInputs.innerHTML = '';
            stations.forEach((station, index) => {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'station-input-group';
                inputGroup.style.flexDirection = 'column';
                inputGroup.style.alignItems = 'stretch';
                inputGroup.style.gap = '10px';
                inputGroup.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <label style="min-width: 100px; text-align: left; font-size: 1.1rem;">정류장 ${index + 1}:</label>
                        <input type="text" class="station-name-input" placeholder="정류장 ${index + 1} 이름" 
                               value="${station.name}" onchange="updateStationName(${index}, this.value)" lang="ko" ime-mode="active">
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <label style="min-width: 100px; text-align: left; font-size: 1.1rem;">오전시간:</label>
                        <input type="number" min="1" max="12" placeholder="시" style="width: 60px; padding: 8px; border: none; border-radius: 5px; background: rgba(255, 255, 255, 0.9); color: #333; text-align: center;" 
                               value="${station.departureTime.morningHour || 8}" onchange="updateDepartureTime(${index}, 'morningHour', this.value)">
                        <span style="color: white;">시</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <label style="min-width: 100px; text-align: left; font-size: 1.1rem;">오후시간:</label>
                        <input type="number" min="1" max="12" placeholder="시" style="width: 60px; padding: 8px; border: none; border-radius: 5px; background: rgba(255, 255, 255, 0.9); color: #333; text-align: center;" 
                               value="${station.departureTime.afternoonHour || 5}" onchange="updateDepartureTime(${index}, 'afternoonHour', this.value)">
                        <span style="color: white;">시</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <label style="min-width: 100px; text-align: left; font-size: 1.1rem;">분:</label>
                        <input type="number" min="0" max="59" placeholder="분" style="width: 60px; padding: 8px; border: none; border-radius: 5px; background: rgba(255, 255, 255, 0.9); color: #333; text-align: center;" 
                               value="${station.departureTime.minute || 0}" onchange="updateDepartureTime(${index}, 'minute', this.value)">
                        <span style="color: white;">분</span>
                    </div>
                `;
                stationInputs.appendChild(inputGroup);
            });
        }

        // 정류장 이름 업데이트
        function updateStationName(index, name) {
            stationNames[index] = name;
            stations[index].name = name;
            
            // 정류장 이름을 localStorage에 저장
            const savedStations = stations.map(station => station.name);
            localStorage.setItem('savedStations', JSON.stringify(savedStations));
            
            checkAllNamesFilled();
        }

        // 출발 시간 업데이트
        function updateDepartureTime(index, type, value) {
            if (!stations[index].departureTime) {
                stations[index].departureTime = { morningHour: 8, afternoonHour: 5, minute: 0 };
            }
            
            if (type === 'morningHour') {
                stations[index].departureTime.morningHour = parseInt(value) || 8;
            } else if (type === 'afternoonHour') {
                stations[index].departureTime.afternoonHour = parseInt(value) || 5;
            } else if (type === 'minute') {
                stations[index].departureTime.minute = parseInt(value) || 0;
            }
            
            // 출발 시간을 localStorage에 저장
            const savedDepartureTimes = stations.map(station => station.departureTime);
            localStorage.setItem('savedDepartureTimes', JSON.stringify(savedDepartureTimes));
        }

        // 모든 정류장 이름이 입력되었는지 확인
        function checkAllNamesFilled() {
            const allFilled = stations.every(station => station.name.trim() !== '');
            document.getElementById('start-counting').disabled = !allFilled;
            document.getElementById('save-route').disabled = !allFilled;
        }

        // 카운팅 시작
        function startCounting() {
            if (stations.every(station => station.name.trim() !== '')) {
                // 정류장 개수와 노선이름을 localStorage에 저장
                localStorage.setItem('savedStationCount', stationCount.toString());
                localStorage.setItem('savedRouteName', routeName);
                
                currentStationIndex = 0;
                updateKeypadPage();
                document.getElementById('station-names-page').classList.add('hidden');
                document.getElementById('keypad-page').classList.remove('hidden');
                
                // 시계 시작
                updateClock();
                setInterval(updateClock, 1000);
            }
        }

        // 다시 설정
        function resetSetup() {
            stationCount = 0;
            stations = [];
            stationNames = [];
            document.getElementById('station-count').value = '';
            document.getElementById('count-submit').disabled = true;
            document.getElementById('station-names-page').classList.add('hidden');
            document.getElementById('station-count-page').classList.remove('hidden');
        }

        // 시계 업데이트 함수
        function updateClock() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const day = now.getDate();
            const weekdays = ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];
            const weekday = weekdays[now.getDay()];
            
            document.getElementById('clock-time').textContent = `${hours}:${minutes}:${seconds}`;
            document.getElementById('clock-date').textContent = `${year}년 ${month}월 ${day}일 ${weekday}`;
        }

        // 키패드 페이지 업데이트
        function updateKeypadPage() {
            // 선택된 시간대에 따른 총 카운트 계산
            const totalCount = selectedTimePeriod === 'morning' ? 
                stations.reduce((sum, station) => sum + (station.morningCount || 0), 0) :
                stations.reduce((sum, station) => sum + (station.afternoonCount || 0), 0);
            
            const currentStation = stations[currentStationIndex];
            
            // 현재 정류장 이름과 운행 시간 표시
            let timeDisplay = '';
            if (currentStation && currentStation.departureTime) {
                const hour = selectedTimePeriod === 'morning' ? 
                    (currentStation.departureTime.morningHour || 8) : 
                    (currentStation.departureTime.afternoonHour || 17);
                const minute = currentStation.departureTime.minute || 0;
                const timeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                timeDisplay = ` (${timeStr})`;
            }
            
            document.getElementById('current-station-name').textContent = `${currentStation.name}${timeDisplay}`;
            document.getElementById('current-station-count').textContent = `총 탑승자수: ${totalCount}`;
            updateSummary();
        }

        // 요약 업데이트 (오전/오후 카운트 분리 표시)
        function updateSummary() {
            const summaryList = document.getElementById('summary-list');
            summaryList.innerHTML = '';
            stations.forEach((station, index) => {
                const summaryItem = document.createElement('div');
                summaryItem.className = `summary-item ${index === currentStationIndex ? 'current' : ''}`;
                
                // 오전/오후 카운트를 분리하여 표시
                const morningCount = station.morningCount || 0;
                const afternoonCount = station.afternoonCount || 0;
                summaryItem.textContent = `${index + 1}. ${station.name}: 오전 ${morningCount}명, 오후 ${afternoonCount}명`;
                
                summaryList.appendChild(summaryItem);
            });
        }

        // 햅틱 피드백 함수 (진동 + 시각적 피드백)
        function hapticFeedback(pattern = 50) {
            // 진동 시도
            if (navigator.vibrate) {
                try {
                    navigator.vibrate(pattern);
                    console.log('진동 실행됨:', pattern + 'ms');
                } catch (e) {
                    console.log('진동 실행 실패:', e);
                }
            } else {
                console.log('이 기기는 진동을 지원하지 않습니다');
            }
            
            // iOS Safari/PWA에서 진동이 안 될 때 시각적 피드백
            if (window.navigator && window.navigator.userAgent.includes('iPhone')) {
                // 화면 전체에 짧은 플래시 효과
                document.body.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                setTimeout(() => {
                    document.body.style.backgroundColor = '';
                }, 100);
            }
        }

        // 숫자 입력
        function inputDigit(digit) {
            // 햅틱 피드백
            hapticFeedback(50);
            
            currentInput += digit;
            document.getElementById('number-display').textContent = currentInput || '0';
        }

        // 입력 초기화
        function clearInput() {
            // 햅틱 피드백
            hapticFeedback(30);
            
            currentInput = '';
            document.getElementById('number-display').textContent = '0';
        }

        // 백스페이스
        function backspace() {
            // 햅틱 피드백
            hapticFeedback(30);
            
            currentInput = currentInput.slice(0, -1);
            document.getElementById('number-display').textContent = currentInput || '0';
        }

        // 엔터 (숫자 입력 완료)
        function enterNumber() {
            // 햅틱 피드백 (더 강한 진동)
            hapticFeedback([50, 30, 50]);
            
            if (currentStationIndex < stations.length) {
                // 입력된 숫자가 있으면 그 값을, 없으면 0을 추가
                const inputValue = currentInput ? parseInt(currentInput) : 0;
                
                // 선택된 시간대에 따라 카운트 저장
                if (selectedTimePeriod === 'morning') {
                    stations[currentStationIndex].morningCount += inputValue;
                } else {
                    stations[currentStationIndex].afternoonCount += inputValue;
                }
                
                // 기존 count도 업데이트 (호환성)
                stations[currentStationIndex].count += inputValue;
                
                currentInput = '';
                document.getElementById('number-display').textContent = '0';
                
                // 마지막 정류장에서 머물도록 수정
                if (currentStationIndex < stations.length - 1) {
                    currentStationIndex++;
                } else {
                    // 마지막 정류장에서는 입력 완료 상태로 변경 (하지만 시간대 전환 시 재활성화 가능)
                    disableKeypad();
                }
                
                updateKeypadPage();
                
                // localStorage에 저장 (오류 처리 포함)
                saveToLocalStorage('savedStations', JSON.stringify(stations));
            }
        }

        // 키패드 비활성화 함수
        function disableKeypad() {
            const keypadButtons = document.querySelectorAll('.keypad-btn, .enter-btn');
            keypadButtons.forEach(button => {
                button.disabled = true;
                button.style.opacity = '0.5';
                button.style.cursor = 'not-allowed';
            });
            
            // 완료 메시지 표시
            const inputDisplay = document.getElementById('number-display');
            inputDisplay.textContent = '완료';
            inputDisplay.style.color = '#4CAF50';
            inputDisplay.style.fontSize = '2rem';
            
            // 키패드 비활성화 상태 저장
            saveToLocalStorage('keypadDisabled', 'true');
        }

        // 키패드 활성화 함수
        function enableKeypad() {
            const keypadButtons = document.querySelectorAll('.keypad-btn, .enter-btn');
            keypadButtons.forEach(button => {
                button.disabled = false;
                button.style.opacity = '1';
                button.style.cursor = 'pointer';
            });
            
            // 입력 표시 복원
            const inputDisplay = document.getElementById('number-display');
            inputDisplay.textContent = '0';
            inputDisplay.style.color = '#fff';
            inputDisplay.style.fontSize = '3rem';
            
            // 키패드 활성화 상태 저장
            saveToLocalStorage('keypadDisabled', 'false');
        }

        // 정류장 명수만 초기화 (수동 초기화: 오전/오후 모두 초기화)
        function resetCounts() {
            if (confirm('정류장별 카운트를 초기화하시겠습니까?\n(오전/오후 모든 카운팅이 초기화됩니다)')) {
                stations.forEach(station => {
                    station.count = 0;
                    station.morningCount = 0;
                    station.afternoonCount = 0;
                });
                currentStationIndex = 0;
                currentInput = '';
                enableKeypad(); // 키패드 다시 활성화
                updateKeypadPage();
                localStorage.setItem('savedStations', JSON.stringify(stations));
                
                console.log('수동 초기화: 오전/오후 모든 카운팅이 초기화되었습니다.');
            }
        }

        // 앱 초기화
        function resetApp() {
            stationCount = 0;
            stations = [];
            stationNames = [];
            currentStationIndex = 0;
            currentInput = '';
            
            // 저장된 정류장 이름과 개수 삭제
            localStorage.removeItem('savedStations');
            localStorage.removeItem('savedStationCount');
            
            document.getElementById('station-count').value = '';
            document.getElementById('count-submit').disabled = true;
            
            document.getElementById('keypad-page').classList.add('hidden');
            document.getElementById('station-names-page').classList.add('hidden');
            document.getElementById('station-count-page').classList.remove('hidden');
        }

        // 직전 정류장 삭제 함수
        function deletePreviousStation() {
            // 완료 상태 확인: 마지막 정류장에 있고 키패드가 비활성화된 경우
            const isCompleted = (currentStationIndex === stations.length - 1);
            const enterBtn = document.querySelector('.enter-btn');
            const isKeypadDisabled = enterBtn && enterBtn.disabled;
            
            if (isCompleted && isKeypadDisabled) {
                alert('모든 정류장 카운팅이 완료된 상태에서는 삭제할 수 없습니다.');
                return;
            }
            
            if (currentStationIndex === 0) {
                alert('첫 번째 정류장은 삭제할 수 없습니다.');
                return;
            }
            
            if (confirm('직전 정류장의 카운트를 삭제하시겠습니까?')) {
                // 직전 정류장의 모든 카운트를 0으로 초기화
                stations[currentStationIndex - 1].count = 0;
                stations[currentStationIndex - 1].morningCount = 0;
                stations[currentStationIndex - 1].afternoonCount = 0;
                
                // 현재 정류장을 직전 정류장으로 이동
                currentStationIndex--;
                
                // localStorage에 저장
                saveToLocalStorage('savedStations', JSON.stringify(stations));
                
                // 키패드 페이지 업데이트
                updateKeypadPage();
                
                console.log('직전 정류장 카운트 삭제 완료');
            }
        }


        // 키보드 이벤트
        document.addEventListener('keydown', function(event) {
            if (document.getElementById('keypad-page').classList.contains('hidden')) return;
            
            // 키패드가 비활성화된 상태에서는 키보드 입력 무시
            const enterBtn = document.querySelector('.enter-btn');
            if (enterBtn && enterBtn.disabled) return;
            
            if (event.key >= '0' && event.key <= '9') {
                inputDigit(event.key);
            } else if (event.key === 'Enter') {
                enterNumber();
            } else if (event.key === 'Escape') {
                clearInput();
            } else if (event.key === 'Backspace') {
                backspace();
            }
        });

        // 페이지 로드 시 초기화
        window.addEventListener('load', function() {
            loadTheme();
            loadSavedTimePeriod();
            loadSavedStations();
            setKoreanInputMode();
            
            // 공유 버튼 이벤트 리스너 추가
            const kakaoShareBtn = document.getElementById('kakao-share-btn');
            if (kakaoShareBtn) {
                kakaoShareBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('카카오톡 공유 버튼 클릭됨');
                    generateAndShareImage();
                });
            }
        });

        // 한글 입력 모드 자동 설정
        function setKoreanInputMode() {
            // 모든 텍스트 입력 필드에 한글 입력 모드 설정
            const textInputs = document.querySelectorAll('input[type="text"]');
            textInputs.forEach(input => {
                input.addEventListener('focus', function() {
                    // 한글 입력 모드 활성화
                    this.setAttribute('lang', 'ko');
                    this.style.imeMode = 'active';
                });
            });
        }

        // 오후 마지막 정류장 출발시간 50분 후 초기화 가능 여부 확인
        function checkAfternoonResetAvailability() {
            if (stations.length === 0) return false;
            
            const lastStation = stations[stations.length - 1];
            const afternoonHour = lastStation.departureTime?.afternoonHour || 17;
            const afternoonMinute = lastStation.departureTime?.minute || 0;
            
            // 오후 마지막 정류장 출발시간 + 50분
            const resetTime = new Date();
            resetTime.setHours(afternoonHour, afternoonMinute + 50, 0, 0);
            
            const now = new Date();
            const canReset = now >= resetTime;
            
            console.log(`오후 마지막 정류장 출발시간: ${afternoonHour}:${String(afternoonMinute).padStart(2, '0')}`);
            console.log(`초기화 가능 시간: ${resetTime.getHours()}:${String(resetTime.getMinutes()).padStart(2, '0')}`);
            console.log(`현재 시간: ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`);
            console.log(`초기화 가능: ${canReset}`);
            
            return canReset;
        }

        // 저장된 시간대 설정 불러오기
        function loadSavedTimePeriod() {
            // 자동 시간대 선택 먼저 실행
            autoSelectTimePeriod();
            
            // 저장된 설정이 있으면 덮어쓰기 (수동 선택 우선)
            const savedPeriod = localStorage.getItem('selectedTimePeriod');
            if (savedPeriod) {
                selectedTimePeriod = savedPeriod;
                updateTimePeriodButtons();
            }
        }

        // 저장된 정류장 정보 불러오기
        function loadSavedStations() {
            const savedStations = JSON.parse(loadFromLocalStorage('savedStations') || '[]');
            const savedStationCount = loadFromLocalStorage('savedStationCount');
            const savedDepartureTimes = JSON.parse(loadFromLocalStorage('savedDepartureTimes') || '[]');
            const savedRouteName = loadFromLocalStorage('savedRouteName');
            
            console.log('로드된 데이터:', {
                savedStations: savedStations.length,
                savedStationCount,
                savedRouteName,
                savedDepartureTimes: savedDepartureTimes.length
            });
            
            if (savedStationCount && savedStations.length > 0) {
                // 저장된 정류장 개수와 이름이 있으면 자동으로 키패드 페이지로 이동
                stationCount = parseInt(savedStationCount);
                routeName = savedRouteName || '';
                
                console.log('설정된 routeName:', routeName);
                
                stations = Array.from({ length: stationCount }, (_, index) => {
                    const savedStation = savedStations[index];
                    const stationName = typeof savedStation === 'string' ? savedStation : (savedStation?.name || '');
                    
                    return {
                        id: index,
                        name: stationName,
                        count: savedStation?.count || 0, // 저장된 카운트 불러오기
                        morningCount: savedStation?.morningCount || 0, // 저장된 오전 카운트 불러오기
                        afternoonCount: savedStation?.afternoonCount || 0, // 저장된 오후 카운트 불러오기
                        departureTime: savedDepartureTimes[index] || { 
                            morningHour: 8, 
                            afternoonHour: 17, 
                            minute: Math.min(index * 5, 59) 
                        }
                    };
                });
                
                // 키패드 페이지로 바로 이동
                document.getElementById('station-count-page').classList.add('hidden');
                document.getElementById('station-names-page').classList.add('hidden');
                document.getElementById('keypad-page').classList.remove('hidden');
                
                // 시계 시작
                updateClock();
                setInterval(updateClock, 1000);
                
                updateKeypadPage();
            }
        }

        // 이미지 생성 및 공유 기능
        let generatedImageDataUrl = null;

        // 이미지 생성 함수 (샘플 이미지와 동일한 구조)
        function generateResultImage() {
            console.log('이미지 생성 시작, routeName:', routeName);
            console.log('현재 선택된 시간대:', selectedTimePeriod);
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // 캔버스 크기 설정 (메인 헤더 제거로 높이 감소)
            canvas.width = 1300;
            canvas.height = 350 + (stations.length * 40); // 메인 헤더 높이만큼 감소
            
            // 배경색 설정
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 테이블 설정
            const tableX = 50;
            const tableY = 50;
            const tableWidth = 1000; // 5개 컬럼 너비 합계: 700 + 100 + 100 + 100 + 100 = 1000
            const rowHeight = 40;
            
            // 컬럼 너비 설정 (5개 컬럼)
            const colWidths = [700, 100, 100, 100, 100]; // 노선명, 오전출발시간, 오전승차인원, 오후출발시간, 오후승차인원
            
            // 테이블 테두리
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 1;
            ctx.strokeRect(tableX, tableY, tableWidth, rowHeight + (stations.length * rowHeight) + rowHeight);
            
            // 컬럼 헤더 행 (주황색/연두색 배경)
            const headerRowY = tableY;
            
            // 컬럼 헤더 배경색 (6개 컬럼)
            let currentX = tableX;
            for (let i = 0; i < colWidths.length; i++) {
                if (i === 0) {
                    // 첫 번째 컬럼 (노선이름 통합) - 주황색
                    ctx.fillStyle = '#FF8C00';
                } else if (i === 1 || i === 3) {
                    // 출발시간 컬럼 - 연두색
                    ctx.fillStyle = '#C6E0B4';
                } else if (i === 2 || i === 4) {
                    // 승차인원 컬럼 - 연두색
                    ctx.fillStyle = '#C6E0B4';
                } else {
                    // 빈공간 컬럼 - 흰색
                    ctx.fillStyle = '#FFFFFF';
                }
                ctx.fillRect(currentX, headerRowY, colWidths[i], rowHeight);
                currentX += colWidths[i];
            }
            
            // 헤더 세로선 그리기
            currentX = tableX;
            for (let i = 0; i < colWidths.length; i++) {
                currentX += colWidths[i];
                ctx.beginPath();
                ctx.moveTo(currentX, headerRowY);
                ctx.lineTo(currentX, headerRowY + rowHeight);
                ctx.stroke();
            }
            
            // 컬럼 헤더 텍스트 (글자 크기 증가)
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 25px Arial';
            ctx.textAlign = 'center';
            
            currentX = tableX;
            const headers = ['', '출발시간', '승차인원', '출발시간', '승차인원'];
            for (let i = 0; i < headers.length; i++) {
                if (i === 0) {
                    // 첫 번째 컬럼에 노선이름 표시 (검은색 텍스트)
                    ctx.fillStyle = '#000000';
                    ctx.fillText(routeName, currentX + colWidths[i]/2, headerRowY + rowHeight/2 + 5);
                } else if (headers[i]) { // 빈 문자열이 아닌 경우만 텍스트 표시
                    ctx.fillStyle = '#000000';
                    ctx.fillText(headers[i], currentX + colWidths[i]/2, headerRowY + rowHeight/2 + 5);
                }
                currentX += colWidths[i];
            }
            
            // 데이터 행들 (글자 크기 증가)
            ctx.font = '23px Arial';
            ctx.textAlign = 'left';
            
            stations.forEach((station, index) => {
                const dataRowY = headerRowY + rowHeight + (index * rowHeight);
                
                // 데이터 행 배경색 설정
                let currentX = tableX;
                for (let i = 0; i < colWidths.length; i++) {
                    if (i === 0) {
                        // 첫 번째 컬럼 (노선이름/번호/정류장명) - 흰색
                        ctx.fillStyle = '#FFFFFF';
                    } else if ((i === 1 || i === 3) && index === 0) {
                        // 첫 번째 정류장의 출발시간 컬럼들만 - 노란색
                        ctx.fillStyle = '#FFFF00';
                    } else {
                        // 나머지 모든 컬럼들 - 흰색
                        ctx.fillStyle = '#FFFFFF';
                    }
                    ctx.fillRect(currentX, dataRowY, colWidths[i], rowHeight);
                    currentX += colWidths[i];
                }
                
                // 행 테두리
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 1;
                ctx.strokeRect(tableX, dataRowY, tableWidth, rowHeight);
                
                // 세로선 그리기
                currentX = tableX;
                for (let i = 0; i < colWidths.length; i++) {
                    currentX += colWidths[i];
                    ctx.beginPath();
                    ctx.moveTo(currentX, dataRowY);
                    ctx.lineTo(currentX, dataRowY + rowHeight);
                    ctx.stroke();
                }
                
                // 번호와 정류장명 표시 (1열에 통합)
                ctx.fillStyle = '#000000';
                ctx.fillText(`${index + 1}. ${station.name}`, tableX + 10, dataRowY + rowHeight/2 + 5);
                
                // 오전/오후 모든 데이터 표시
                const morningHour = station.departureTime?.morningHour || 8;
                const morningMinute = station.departureTime?.minute || 0;
                const morningTimeStr = `${morningHour}:${String(morningMinute).padStart(2, '0')}`;
                
                const afternoonHour = station.departureTime?.afternoonHour || 17;
                const afternoonMinute = station.departureTime?.minute || 0;
                const afternoonTimeStr = `${afternoonHour}:${String(afternoonMinute).padStart(2, '0')}`;
                
                ctx.textAlign = 'center';
                
                // 오전 출발시간 (2열)
                ctx.fillStyle = '#000000';
                ctx.fillText(morningTimeStr, tableX + colWidths[0] + colWidths[1]/2, dataRowY + rowHeight/2 + 5);
                
                // 오전 승차인원 (3열)
                ctx.fillStyle = '#000000';
                ctx.fillText(station.morningCount?.toString() || '0', tableX + colWidths[0] + colWidths[1] + colWidths[2]/2, dataRowY + rowHeight/2 + 5);
                
                // 오후 출발시간 (4열)
                ctx.fillStyle = '#000000';
                ctx.fillText(afternoonTimeStr, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3]/2, dataRowY + rowHeight/2 + 5);
                
                // 오후 승차인원 (5열)
                ctx.fillStyle = '#000000';
                ctx.fillText(station.afternoonCount?.toString() || '0', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4]/2, dataRowY + rowHeight/2 + 5);
                
                ctx.textAlign = 'left';
            });
            
            // 총계 행 (흰색 배경)
            const totalRowY = headerRowY + rowHeight + (stations.length * rowHeight);
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(tableX, totalRowY, tableWidth, rowHeight);
            
            // 총계 행 세로선 그리기
            currentX = tableX;
            for (let i = 0; i < colWidths.length; i++) {
                currentX += colWidths[i];
                ctx.beginPath();
                ctx.moveTo(currentX, totalRowY);
                ctx.lineTo(currentX, totalRowY + rowHeight);
                ctx.stroke();
            }
            
            // "계" 텍스트 (글자 크기 증가)
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 25px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('계', tableX + 10, totalRowY + rowHeight/2 + 5);
            
            // 총계 계산 및 표시 (오전/오후 모든 데이터)
            ctx.textAlign = 'center';
            const morningTotal = stations.reduce((sum, station) => sum + (station.morningCount || 0), 0);
            const afternoonTotal = stations.reduce((sum, station) => sum + (station.afternoonCount || 0), 0);
            
            // 오전 총계 (3열)
            ctx.fillText(morningTotal.toString(), tableX + colWidths[0] + colWidths[1] + colWidths[2]/2, totalRowY + rowHeight/2 + 5);
            
            // 오후 총계 (5열)
            ctx.fillText(afternoonTotal.toString(), tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4]/2, totalRowY + rowHeight/2 + 5);
            
            return canvas.toDataURL('image/png');
        }

        // 이미지 생성 및 공유
        function generateAndShareImage() {
            if (stations.length === 0) {
                return;
            }
            
            try {
                generatedImageDataUrl = generateResultImage();
                
                // 이미지 미리보기 표시
                const modal = document.getElementById('image-modal');
                const img = document.getElementById('generated-image');
                img.src = generatedImageDataUrl;
                modal.classList.add('show');
                
                console.log('이미지 생성 완료:', generatedImageDataUrl ? '성공' : '실패');
                
                // 카카오톡 공유 시도
                setTimeout(() => {
                    shareToKakao();
                }, 1000);
            } catch (error) {
                console.error('이미지 생성 오류:', error);
            }
        }

        // 카카오톡 공유 함수
        function shareToKakao() {
            if (!generatedImageDataUrl) {
                return;
            }
            
            console.log('공유 시도 중...');
            
            // 공유 시작
            isSharing = true;
            
            // Web Share API 사용 (모바일에서 카카오톡 공유 가능)
            if (navigator.share) {
                console.log('Web Share API 지원됨');
                
                // 이미지를 Blob으로 변환
                fetch(generatedImageDataUrl)
                    .then(res => res.blob())
                    .then(blob => {
                        console.log('Blob 생성 완료:', blob.size, 'bytes');
                        const file = new File([blob], 'bus-count-result.png', { type: 'image/png' });
                        
                        navigator.share({
                            files: [file]
                        }).then(() => {
                            console.log('공유 성공');
                            // 공유 완료 후 3초 뒤 플래그 해제
                            setTimeout(() => {
                                isSharing = false;
                            }, 3000);
                        }).catch(err => {
                            console.log('공유 실패:', err);
                            isSharing = false;
                        });
                    })
                    .catch(err => {
                        console.error('Blob 생성 실패:', err);
                        isSharing = false;
                    });
            } else {
                console.log('Web Share API 미지원');
                isSharing = false;
            }
        }

        // 이미지 모달 닫기
        function closeImageModal() {
            const modal = document.getElementById('image-modal');
            modal.classList.remove('show');
        }

        // 모달 외부 클릭 시 닫기
        document.getElementById('image-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageModal();
            }
        });

        // 자동 카운트 초기화 함수 (오후 마지막 정류장 출발시간 50분 후)
        function resetAllCounts() {
            if (stations && stations.length > 0) {
                // 오후 마지막 정류장 출발시간 50분 후인지 확인
                if (checkAfternoonResetAvailability()) {
                    stations.forEach(station => {
                        // 오전/오후 모든 카운팅 초기화
                        station.count = 0;
                        station.morningCount = 0;
                        station.afternoonCount = 0;
                    });
                    currentStationIndex = 0;
                    currentInput = '';
                    enableKeypad();
                    updateKeypadPage();
                    localStorage.setItem('savedStations', JSON.stringify(stations));
                    console.log('자동 초기화: 오후 마지막 정류장 출발시간 50분 경과로 오전/오후 모든 카운팅이 초기화되었습니다.');
                }
            }
        }

        // 키패드 상태 복원 함수
        function restoreKeypadState() {
            const keypadDisabled = localStorage.getItem('keypadDisabled');
            if (keypadDisabled === 'true') {
                // 키패드가 비활성화된 상태였다면, 현재 시간대에 따라 재활성화 여부 결정
                const now = new Date();
                const currentHour = now.getHours();
                
                // 오전 시간대(6-12시)이고 오전 운행이 완료된 경우, 또는 오후 시간대(13-22시)이고 오후 운행이 완료된 경우
                if ((currentHour >= 6 && currentHour < 12 && selectedTimePeriod === 'morning') ||
                    (currentHour >= 13 && currentHour < 22 && selectedTimePeriod === 'afternoon')) {
                    // 해당 시간대 운행이 완료된 상태이므로 키패드 비활성화 유지
                    disableKeypad();
                } else {
                    // 다른 시간대로 전환 가능하므로 키패드 활성화
                    enableKeypad();
                }
            }
        }

        // 페이지 로드 시 초기화
        window.addEventListener('load', function() {
            loadTheme();
            loadSavedStations();
            loadSavedTimePeriod();
            setKoreanInputMode();
            
            // 저장된 노선 목록 표시
            updateSavedRoutesDisplay();
            
            // 날짜 변경 확인 (페이지 로드 시)
            checkDateChangeAndReset();
            
            // 키패드 상태 복원
            setTimeout(() => {
                restoreKeypadState();
            }, 100);
        });

        // 공유 중인지 확인하는 변수
        let isSharing = false;

        // localStorage 저장 함수 (오류 처리 포함)
        function saveToLocalStorage(key, value) {
            try {
                localStorage.setItem(key, value);
                console.log(`저장 성공: ${key}`);
                return true;
            } catch (error) {
                console.error(`저장 실패: ${key}`, error);
                // 저장 실패 시 사용자에게 알림
                if (error.name === 'QuotaExceededError') {
                    alert('저장 공간이 부족합니다. 브라우저 데이터를 정리해주세요.');
                } else if (error.name === 'SecurityError') {
                    alert('보안 설정으로 인해 저장할 수 없습니다. 브라우저 설정을 확인해주세요.');
                } else {
                    alert('데이터 저장에 실패했습니다. 페이지를 새로고침하지 마세요.');
                }
                return false;
            }
        }

        // localStorage 불러오기 함수 (오류 처리 포함)
        function loadFromLocalStorage(key, defaultValue = null) {
            try {
                const value = localStorage.getItem(key);
                console.log(`불러오기 성공: ${key}`, value);
                return value;
            } catch (error) {
                console.error(`불러오기 실패: ${key}`, error);
                return defaultValue;
            }
        }

        // 모바일 기기 감지 함수
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                   (navigator.maxTouchPoints && navigator.maxTouchPoints > 2) ||
                   window.innerWidth <= 768;
        }

        // 노선 저장 함수
        function saveRoute() {
            if (!routeName || stations.length === 0) {
                alert('저장할 노선 정보가 없습니다.');
                return;
            }
            
            const routeData = {
                name: routeName,
                stationCount: stationCount,
                stations: stations.map(station => ({
                    name: station.name,
                    departureTime: station.departureTime
                })),
                savedAt: new Date().toISOString()
            };
            
            const savedRoutes = JSON.parse(loadFromLocalStorage('savedRoutes') || '[]');
            savedRoutes.push(routeData);
            
            if (saveToLocalStorage('savedRoutes', JSON.stringify(savedRoutes))) {
                alert(`"${routeName}" 노선이 저장되었습니다.`);
                updateSavedRoutesDisplay();
            }
        }

        // 저장된 노선 불러오기 함수
        function loadRoute(routeData) {
            if (confirm(`"${routeData.name}" 노선을 불러오시겠습니까?`)) {
                routeName = routeData.name;
                stationCount = routeData.stationCount;
                
                // 정류장 데이터 복원
                stations = routeData.stations.map(station => ({
                    name: station.name,
                    count: 0,
                    morningCount: 0,
                    afternoonCount: 0,
                    departureTime: station.departureTime
                }));
                
                // 입력 필드 업데이트
                document.getElementById('route-name').value = routeName;
                document.getElementById('station-count').value = stationCount;
                
                // 정류장 이름 입력 페이지로 이동
                document.getElementById('station-count-page').classList.add('hidden');
                document.getElementById('station-names-page').classList.remove('hidden');
                createStationInputs();
                
                console.log(`"${routeData.name}" 노선을 불러왔습니다.`);
            }
        }

        // 저장된 노선 목록 표시 업데이트
        function updateSavedRoutesDisplay() {
            const savedRoutes = JSON.parse(loadFromLocalStorage('savedRoutes') || '[]');
            const routesContainer = document.getElementById('saved-routes-container');
            
            if (!routesContainer) return;
            
            routesContainer.innerHTML = '';
            
            if (savedRoutes.length === 0) {
                routesContainer.innerHTML = '<p style="color: #999; text-align: center; margin: 10px 0;">저장된 노선이 없습니다.</p>';
                return;
            }
            
            savedRoutes.forEach((route, index) => {
                const routeButton = document.createElement('button');
                routeButton.className = 'saved-route-btn';
                routeButton.innerHTML = `
                    <div class="route-name">${route.name}</div>
                    <div class="route-info">${route.stationCount}개 정류장</div>
                `;
                routeButton.onclick = () => loadRoute(route);
                
                const deleteButton = document.createElement('button');
                deleteButton.className = 'delete-route-btn';
                deleteButton.innerHTML = '×';
                deleteButton.onclick = (e) => {
                    e.stopPropagation();
                    deleteRoute(index);
                };
                
                const routeItem = document.createElement('div');
                routeItem.className = 'saved-route-item';
                routeItem.appendChild(routeButton);
                routeItem.appendChild(deleteButton);
                
                routesContainer.appendChild(routeItem);
            });
        }

        // 노선 삭제 함수
        function deleteRoute(index) {
            const savedRoutes = JSON.parse(loadFromLocalStorage('savedRoutes') || '[]');
            const route = savedRoutes[index];
            
            if (confirm(`"${route.name}" 노선을 삭제하시겠습니까?`)) {
                savedRoutes.splice(index, 1);
                saveToLocalStorage('savedRoutes', JSON.stringify(savedRoutes));
                updateSavedRoutesDisplay();
                alert(`"${route.name}" 노선이 삭제되었습니다.`);
            }
        }

        // 자동 초기화 이벤트 제거 - 모바일과 컴퓨터 동일하게 처리
        // 수동 초기화만 가능 ("정류장 명수 초기화" 버튼)
        
        /*
        // 페이지 가시성 변경 이벤트 (모바일에서만 작동)
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible' && !isSharing && isMobileDevice()) {
                // 모바일에서만 공유 중이 아닐 때 오후 카운팅 초기화 (오전 카운팅 보존)
                console.log('모바일에서 페이지가 다시 보이게 됨 - 오후 카운팅 초기화');
                resetAllCounts();
            }
        });

        // 페이지 포커스 이벤트 (모바일에서만 작동)
        window.addEventListener('focus', function() {
            if (!isSharing && isMobileDevice()) {
                console.log('모바일에서 페이지 포커스 - 오후 카운팅 초기화');
                resetAllCounts();
            }
        });

        // 페이지 언로드 전 이벤트 (모바일에서만 작동)
        window.addEventListener('beforeunload', function() {
            if (!isSharing && isMobileDevice()) {
                console.log('모바일에서 페이지 언로드 - 오후 카운팅 초기화');
                resetAllCounts();
            }
        });
        */
    </script>
</body>
</html>
</html>